name: Build and Deploy to Staging

on:
    push:
        branches:
            - staging

permissions:
    id-token: write
    contents: read

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Set up .NET Core
              uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: "8.0.x"

            - name: Restore Dependencies
              run: dotnet restore

            - name: Publish
              run: dotnet publish -c Release -o ./publish

            - name: Zip Published Output
              run: |
                cd publish
                zip -r ../app.zip .

            - name: Upload Artifact
              uses: actions/upload-artifact@v3
              with:
                  name: app
                  path: app.zip

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download Artifact
              uses: actions/download-artifact@v3
              with:
                  name: app
                  path: ./

            - name: Login via Azure CLI
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}
                  enable-AzPSSession: true

            - name: Deploy to Azure Web App
              run: |
                  az webapp deploy --resource-group berth-rg-development-westeurope-01 \
                  --name berth-app-development-westeurope-01 \
                  --src-path app.zip \
                  --type zip
